name: Release

on:
  push:
    branches:
      - master

jobs:
  version:
    name: Generate next version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.out.outputs.version}}
      tag: ${{ steps.out.outputs.tag}}
      notes: ${{ steps.out.outputs.notes}}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm ci
      - name: Generate version
        id: sr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx semantic-release --dry-run --no-ci | tee sr.log
      - run: cat sr.log
      - name: Extract version and notes
        id: out
        run: |
          VERSION=$(grep -Eo "next release version is [0-9]+\.[0-9]+\.[0-9]+" -m1 sr.log | grep -Eo "[0-9]+\.[0-9]+\.[0-9]+")
          if [ -z "$VERSION" ]; then
            echo "No release detected"
            echo "version=" >> $GITHUB_OUTPUT
            echo "tag=" >> $GITHUB_OUTPUT
            echo "notes=" >> $GITHUB_OUTPUT
            exit 0
          fi

          TAG="v$VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          echo "notes=Automated release $TAG" >> $GITHUB_OUTPUT
      - name: Stop if no release
        if: ${{ steps.out.outputs.version == ''}}
        run: echo "No release to publish, stopping workflow" && exit 0
      - name: Create and push tag
        if: ${{ steps.out.outputs.version != ''}}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.out.outputs.tag }}" -m "Release ${{ steps.out.outputs.tag }}"
          git push origin "${{ steps.out.outputs.tag }}"
  build:
    name: Build and upload artifacts
    needs: version
    if: ${{ needs.version.outputs.version != '' }}
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ needs.version.outputs.tag}}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Checkout tag
        run: |
          git fetch --tags
          git checkout "${{ needs.version.outputs.tag}}"
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x
      - name: Set build version
        env:
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          python3 - << 'PY'
          import os, xml.etree.ElementTree as ET

          version = os.environ['VERSION']
          path = "VectraCompiler/VectraCompiler.csproj"

          tree = ET.parse(path)
          root = tree.getroot()

          ns = ""
          if root.tag.startswith("{"):
            ns = root.tag.split("}")[0] + "}"
          def find_or_create(parent, tag):
            el = parent.find(f"{ns}{tag}")
            if el is None:
              el = ET.SubElement(parent, f"{ns}{tag}")
            return el
          pg = root.find(f"{ns}PropertyGroup")
          if pg is None:
            pg = ET.SubElement(root, f"{ns}PropertyGroup")
          find_or_create(pg, "Version").text = version
          find_or_create(pg, "AssemblyVersion").text = version
          find_or_create(pg, "FileVersion").text = version
          find_or_create(pg, "InformationalVersion").text = version

          tree.write(path, encoding="utf-8", xml_declaration=True)
          print(f"Stamped {path} with version {version}")
          PY
      - name: Restore
        run: dotnet restore
      - name: Build
        run: dotnet build -c Release --no-restore
      - name: Publish CLI
        run: |
          dotnet publish VectraCompiler/VectraCompiler.csproj -c Release -r win-x64 --self-contained true -o out/win-x64 --no-restore
          dotnet publish VectraCompiler/VectraCompiler.csproj -c Release -r linux-x64 --self-contained true -o out/linux-x64 --no-restore
          (cd out && zip -r vectra-win-x64.zip win-x64)
          (cd out && zip -r vectra-linux-x64.zip linux-x64)
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            out/vectra-win-x64.zip
            out/vectra-linux-x64.zip
  release:
    name: CreateGitHub release
    runs-on: ubuntu-latest
    needs: [version, build]
    if: ${{ needs.version.outputs.version != '' }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: out
      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ needs.version.outputs.tag }}" \
          out/vectra-win-x64.zip \
          out/vectra-linux-x64.zip \
          --title "${{ needs.version.outputs.tag }}" \
          --notes "${{ needs.version.outputs.notes }}"